------------------------------------------------------------
ã€æœ€çµ‚ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆåˆ¶ä½œæå‡ºã«ã¤ã„ã¦ã®ãŠçŸ¥ã‚‰ã›ã€‘
------------------------------------------------------------
çš†ã•ã¾ã€ãŠç–²ã‚Œã•ã¾ã§ã™ï¼:ãã¤ã‚ã:
ã‚ã‘ã¾ã—ã¦ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼ä»Šå¹´ã‚‚ã©ã†ãã‚ˆã‚ã—ããŠé¡˜ã„ã—ã¾ã™ã€‚
æœ¬æ ¼çš„ã«æœ€çµ‚ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆåˆ¶ä½œã«åŠ±ã¾ã‚Œã¦ã„ã‚‹ã“ã¨ã¨æ€ã„ã¾ã™ã€‚
ã•ã¦ã€æœ¬æ—¥ã¯å¤§äº‹ãªãŠçŸ¥ã‚‰ã›ãŒã‚ã‚Šã¾ã™ã€‚
ã„ãšã‚Œã‚‚ååˆ†ã”ç¢ºèªãã ã•ã„ã¾ã™ã‚ˆã†ãŠé¡˜ã„ã„ãŸã—ã¾ã™ï¼
æœ€çµ‚æå‡ºã¨ã‚»ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ãƒ»ãƒ‡ãƒ¢ãƒ‡ãƒ¼ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã®é–“ã«çµæ§‹æ™‚é–“ãŒã‚ã‚Šã¾ã™ã®ã§ã€
æå‡ºå¾Œã‹ã‚‰ã‚‚ãƒ–ãƒ©ãƒƒã‚·ãƒ¥ã‚¢ãƒƒãƒ—OKã§ã™ã€‚:+1:
1/24(æ°´)ã«ã¾ã æœ€çµ‚ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆæå‡ºã«ã¯å®Ÿè£…ã§ãã¦ãªã„çŠ¶æ…‹ã§ã‚ã‚Œã°ã€
ã‚»ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³æ—¥ã¾ã§ã¯ã“ã“ã¾ã§å®Ÿè£…ã—ã¾ã™ï¼ã¨ã„ã†ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«æ„Ÿã‚’ä¼ç”»æ›¸ã«ä½œæˆã—ã¦ãã ã•ã„ã€‚
:é›»çƒ:æå‡ºæœŸé™
1/24(æ°´) 23:59ã¾ã§ã«æœ€çµ‚ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆæå‡ºãƒ•ã‚©ãƒ¼ãƒ ã‚ˆã‚Šæå‡ºã™ã‚‹
https://forms.gle/1M4L8FoPCZGneHiP7
:é›»çƒ:ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã®æå‡ºã«å¿…è¦ãªã‚‚ã®
ã€€â‘ ä¼ç”»æ›¸ã®URL
ã€€â‘¡ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã®URL
â€»google driveã‚„boxãªã©ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã€æ¨©é™ã‚’è¨­å®šã—ãŸä¸Šã§URLã‚’æ·»ä»˜ã—ã¦ãã ã•ã„ã€‚
â€»ã„ãšã‚Œã‚‚æœ€ä½é™ã€Œå‹•ãã“ã¨ã€ãŒå¿…é ˆã€‚é™çš„ãªãƒšãƒ¼ã‚¸ã®ã¿ã¯NGã¨ã„ã†ã“ã¨ã§ã™ã€‚
:é›»çƒ:ä¼ç”»æ›¸ã¨ã¯ï¼Ÿ
æœ€çµ‚ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã«ã¯ã©ã®ã‚ˆã†ãªæ©Ÿèƒ½ãŒã‚ã‚‹ã®ã‹èª¬æ˜ãŒãªã•ã‚Œã¦ã„ã‚‹ã‚‚ã®ã¨ã—ã¦ã€
ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã®ä»•æ§˜æ›¸ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã«è¿‘ã„ã§ã™ã€‚
ä¼ç”»æ›¸ã®ç›®çš„ã¯ã€å®Ÿéš›ã«æå‡ºã„ãŸã ã„ãŸãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸãƒ—ãƒ­ãƒ€ã‚¯ãƒˆãŒ
ã‚»ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³å‚åŠ ã®åŸºæº–ã«åˆã†ã‹ã©ã†ã‹ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã‚‚ã®ã¨ãªã‚Šã¾ã™ã€‚
ãƒ¡ã‚¤ãƒ³ã¯ã€Œãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã€ã§ã€ä¼ç”»æ›¸ã¯ã€Œã‚µãƒ–ã€ã®èªè­˜ã§ãŠé¡˜ã„ã—ã¾ã™ã€‚
â€»ä¼ç”»æ›¸ã¯PowerPointãƒ»google slideãƒ»PDFã§ä½œæˆã—ãŸãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³è³‡æ–™ã‚’æƒ³å®šã—ã¦ã„ã¾ã™ã€‚
:é›»çƒ:ä¼ç”»æ›¸ã«æœ€ä½é™æ²è¼‰ãŒå¿…è¦ãªã‚‚ã®
ã€€â‘ ã©ã‚“ãªãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã‚’ä½œã£ãŸã®ã‹
ã€€ã€€â†’ã€€ãœã²ã‚µãƒ¼ãƒ“ã‚¹åã‚’ã¤ã‘ã¦ã‚ã’ã¾ã—ã‚‡ã†ï¼
ã€€â‘¡ã‚³ã‚¢ã¨ãªã‚‹æ©Ÿèƒ½ã¯ä½•ã‹
ã€€â‘¢ãã‚Œã‚’ã©ã®ã‚ˆã†ã«ä½œã£ã¦ã„ã‚‹ã®ã‹ã€€
ã€€ã€€â†’ã€€ä»•æ§˜æ›¸ã®ã‚ˆã†ãªã©ã“ã«ä½•ãŒã‚ã‚Šã€ã©ã†ã„ã†ä½¿ã„æ–¹ã‚’ã™ã‚Œã°
ã€€ã€€ã€€ã€€ã‚³ã‚¢æ©Ÿèƒ½ã¨ã—ã¦å‹•ãã‹ã¨ã„ã†èª¬æ˜ãŒã‚ã‚‹ã¨å’æ¥­èªå®šã®åˆ¤æ–­ãŒã—ã‚„ã™ã„ã§ã™ã€‚æœ€ä½ãƒ©ã‚¤ãƒ³ã¯ä½¿ç”¨æŠ€è¡“ã‚’è¨˜è¼‰ãã ã•ã„ã€‚
ã€€â‘£ãƒãƒ¼ãƒ åˆ¶ä½œã®å ´åˆã¯ãƒãƒ¼ãƒ ã®å½¹å‰²åˆ†æ‹…
ã€€ã€€â†’ã€€ã“ã“ã§çŸ¥ã‚ŠãŸã„ã®ã¯ã€Œãƒãƒ¼ãƒ ã®ä¸­ã§èª°ãŒã©ã®ã‚ˆã†ã«é–‹ç™ºã‚’ã—ã¦ã„ãŸã‹ã€ã§ã™ã€‚
ã€€ã€€ã€€ã€€ãƒãƒ¼ãƒ ã§ã®åˆ¶ä½œã®å ´åˆã€ï¼‘ã¤ã®ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã§ãƒ¡ãƒ³ãƒãƒ¼å…¨å“¡ãŒèªå®šã‚’å—ã‘ã‚‰ã‚Œã‚‹åƒãã‚’ã©ã†ã—ã¦ã„ã‚‹ã®ã‹ã€ã‚’æŠŠæ¡ã—ã€
ã€€ã€€ã€€ã€€å…¨å“¡ãŒã‚»ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã«å‚åŠ ã§ãã‚‹ã‹ã©ã†ã‹ã®åˆ¤æ–­ã‚’ã—ãŸã„ã¨æ€ã£ã¦ã„ã¾ã™ã€‚
:é›»çƒ:æœ€çµ‚ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆèªå®šã®åŸºæº–
ä»¥ä¸‹ã®2ç‚¹ã‚’æº€ãŸã™ã“ã¨ã§ã™ã€‚
ã€€â‘ å‹•çš„ã§ã‚ã‚‹ã“ã¨
ã€€â‘¡ä¼ç”»ã®ã‚³ã‚¢æ©Ÿèƒ½ãŒå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹ã“ã¨
ã€€â€»å‹•çš„ï¼DBã¨é€£æºã—ã¦CRUDå‡¦ç†ãŒã§ãã¦ã„ã‚‹ã“ã¨
ã€€â€»æœ€çµ‚ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã¯ä¼ç”»æ›¸ã®é€šã‚Šã«ã¾ãšã¯å‹•ãã“ã¨ãŒæ±‚ã‚ã‚‰ã‚Œã¾ã™ã€‚
ã€€ä¼ç”»æ›¸é€šã‚Šã«ã§ãã¦ã„ãªã‹ã£ãŸå ´åˆã¯ã€ä¼ç”»æ›¸ã«æ²¿ã£ã¦æ©Ÿèƒ½ãŒå®Ÿè£…ã§ãã¦ã„ãªã„ã€ã¨ã„ã†ã“ã¨ã«ãªã£ã¦ã—ã¾ã„ã¾ã™ã®ã§NGã§ã™ã€‚
:é›»çƒ:ã‚»ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³å‚åŠ æ¡ä»¶ï¼š
æœ€çµ‚ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆï¼ˆä¼ç”»æ›¸&ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆï¼‰ã‚’æå‡ºã—ã¦ã„ã‚‹ã“ã¨


import streamlit as st
import os
import openai
from pydub import AudioSegment
import tempfile

# Initialize the OpenAI API
def get_api():
    user_api_key = st.sidebar.text_input(
        label="OpenAI API key",
        placeholder="Paste your OpenAI API key here",
        type="password"
    )
    return user_api_key

# Function to convert M4A to MP3
def convert_m4a_to_mp3(m4a_file_path):
    mp3_file_path = os.path.splitext(m4a_file_path)[0] + '.mp3'
    audio = AudioSegment.from_file(m4a_file_path, format="m4a")
    audio.export(mp3_file_path, format="mp3")
    return mp3_file_path

def split_audio(mp3_file_path, interval_ms, output_folder):
    audio = AudioSegment.from_file(mp3_file_path)
    file_name, ext = os.path.splitext(os.path.basename(mp3_file_path))
    mp3_file_path_list = []
    n_splits = len(audio) // interval_ms
    for i in range(n_splits + 1):
        start = i * interval_ms
        end = (i + 1) * interval_ms
        split = audio[start:end]
        output_file_name = os.path.join(output_folder, f"{file_name}_{i}.mp3")
        split.export(output_file_name, format="mp3")
        mp3_file_path_list.append(output_file_name)
    return mp3_file_path_list

def transcribe_audio(mp3_file_path, api_key):
    try:
        openai.api_key = api_key  # Set the API key
        with open(mp3_file_path, 'rb') as audio_file:
            transcript = openai.Audio.transcribe("whisper-1", audio_file)
        return transcript['text']
    except Exception as e:
        return f"Error in transcribe_audio: {str(e)}"

import openai
import openai
import streamlit


def generate_minutes_chunks(transcription_list, agenda_text, api_key, max_tokens=2048, model="gpt-3.5-turbo"):
    chunks = []
    for text in transcription_list:
        prompt = "##The following text is a transcription a conversation that took place at the meeting. The agenda for the meeting is as follow##agenda_text = {" + agenda_text + "} "+ "##The following is the content of the meeting.##text ={" + text + "}"
        response = openai.ChatCompletion.create(
            model=model,
            messages=[
                {"role": "system", "content": "You are a professional minute-taker.Be sure to answer in Japanese.Please complement as much as possible, taking into account the context, any misspellings or unintelligible meanings."},
                {"role": "user", "content": prompt},
            ],
            max_tokens=max_tokens,  # Adjust as needed
            api_key=api_key,
            # stream=True,
        )
        # result_area = streamlit.empty()
        # text = ''
        # for chunk in response:
        #     next = chunk.choices[0].message.content
        #     text += next
        #     result_area.write(text)
            
        minutes_chunk = response.choices[0].message.content
        chunks.append(minutes_chunk)
        st.write(f"Chunk :")
        st.write(minutes_chunk)
        st.write("----")
    return chunks



def main():
    st.title("è­°äº‹éŒ²ç”ŸæˆğŸ“‘")

    user_api_key = get_api()

    # Add agenda upload
    agenda_text = st.text_area("Upload Meeting Agenda (Text)", height=500)

    uploaded_file = st.file_uploader("Upload an audio file", type=["m4a"])

    if uploaded_file:
        st.sidebar.info("Processing... Please wait.")

        temp_dir_path = tempfile.mkdtemp()
        m4a_file_path = os.path.join(temp_dir_path, "uploaded.m4a")
        uploaded_file.seek(0)
        with open(m4a_file_path, "wb") as f:
            f.write(uploaded_file.getvalue())
        st.sidebar.text("Converting audio to mp3...")
        mp3_file_path = convert_m4a_to_mp3(m4a_file_path)
        st.sidebar.text("Splitting audio into chunks...")
        interval_ms = 200_000  # 60 seconds = 60,000 milliseconds
        mp3_file_path_list = split_audio(mp3_file_path, interval_ms, temp_dir_path)
        st.sidebar.text("Transcribing and summarizing...")

        transcription_list = [transcribe_audio(mp3_file, user_api_key) for mp3_file in mp3_file_path_list]

        st.sidebar.text("Processing complete!")

        # Include agenda text in minutes generation with chunks
        minutes_chunks = generate_minutes_chunks(transcription_list, agenda_text, user_api_key)

        st.subheader("Generated Minutes")

        # for i, chunk in enumerate(minutes_chunks):
        #     st.write(f"Chunk {i + 1}:")
        #     st.write(chunk)
        #     st.write("----")

        st.button("Copy the Script")
        #st.download_button(
        #    "Download Minutes",
        #    "\n\n".join(minutes_chunks).encode("utf-8"),
        #    file_name="minutes.txt",
        #    key="download-button",
        #)

if __name__ == "__main__":
    main()
